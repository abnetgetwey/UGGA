<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unity Gebigubae | ·ã©·äí·â≤ ·åç·â¢-·åâ·â£·ä§</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@300;400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --primary: #F9B233;
            --primary-dark: #e09e2b;
            --secondary: #2c3e50;
            --accent: #27ae60;
            --bg: #f4f6f8;
            --white: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --danger: #e74c3c;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', 'Noto Sans Ethiopic', sans-serif; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 80px; }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .p-4 { padding: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        
        /* Inputs & Buttons */
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: var(--radius);
            margin-bottom: 10px; font-size: 1rem; outline: none;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        button { cursor: pointer; border: none; outline: none; transition: all 0.2s; font-family: inherit; }
        .btn {
            background: var(--primary); color: var(--secondary); padding: 12px 20px;
            border-radius: var(--radius); font-weight: 600; width: 100%;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--secondary); }

        /* Layouts */
        header {
            background: var(--white); padding: 15px 20px; box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 40px; width: 40px; object-fit: contain; }
        .app-title { font-weight: 700; font-size: 1.1rem; color: var(--secondary); }

        main { padding: 20px; max-width: 1000px; margin: 0 auto; } 
        .card { background: var(--white); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .card h3 { color: var(--secondary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); display: inline-block; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .nav-card { text-align: center; cursor: pointer; padding: 15px; background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid transparent; }
        .nav-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 5px; display: block; }

        .quote-box { background: var(--primary); color: var(--secondary); padding: 25px; border-radius: var(--radius); text-align: center; font-style: italic; }
        
        /* Media Embeds */
        .media-feed-wrapper { display: flex; flex-direction: column; gap: 25px; padding-bottom: 20px; }
        .media-card { background: #fff; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; }
        .media-header { width: 100%; padding: 15px; font-weight: 600; color: var(--secondary); border-bottom: 1px solid #eee; background: #fff; z-index: 2; }
        .responsive-iframe-container { width: 100%; background: #000; position: relative; display: flex; justify-content: center; }
        .video-16-9 { position: relative; padding-bottom: 56.25%; height: 0; width: 100%; }
        .video-9-16 { position: relative; padding-bottom: 177%; height: 0; width: 100%; max-width: 400px; }
        .responsive-iframe-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        .telegram-link-card { display: flex; align-items: center; gap: 15px; padding: 20px; background: #f9f9f9; border-radius: 8px; width: 100%; }
        .telegram-icon { font-size: 2rem; }

        /* QR */
        #reader { width: 100%; max-width: 500px; margin: 0 auto; border-radius: var(--radius); overflow: hidden; background: #000; }
        .qr-display { width: 180px; height: 180px; background: #eee; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--secondary); }
        .qr-display img { width: 100%; height: 100%; object-fit: contain; }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 0.85rem; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background: #eee; font-weight: 600; color: var(--secondary); }
        .total-row { font-weight: bold; background: #f0f0f0; }

        /* Admin Tabs */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .a-tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #888; border-bottom: 3px solid transparent; white-space: nowrap; }
        .a-tab.active { color: var(--secondary); border-bottom-color: var(--primary); }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 200; }
        .nav-item { text-align: center; font-size: 0.75rem; color: var(--text-light); background: none; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-icon-bottom { font-size: 1.2rem; display: block; margin-bottom: 2px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: var(--radius); width: 90%; max-width: 600px; text-align: center; position: relative; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }
        
        .filter-group { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left; border: 1px solid #eee; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .checkbox-label { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; }

        /* Dynamic Form Builder Styles */
        .form-builder-row {
            display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; 
            padding-bottom: 15px; border-bottom: 1px dashed #ccc;
        }
        .field-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #eee; margin-bottom: 5px; border-radius: 4px; }
        
        @media (min-width: 768px) {
            body { padding-bottom: 0; padding-left: 260px; }
            .bottom-nav { width: 260px; height: 100vh; flex-direction: column; justify-content: flex-start; padding-top: 80px; left: 0; top: 0; align-items: stretch; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
            .nav-item { padding: 20px; font-size: 1rem; text-align: left; display: flex; align-items: center; gap: 15px; }
            .nav-icon-bottom { display: inline-block; font-size: 1.2rem; margin: 0; }
            main { max-width: 1100px; }
        }
    </style>
</head>
<body>

    <!-- Scan Modal -->
    <div id="scan-result-modal" class="hidden modal">
        <div class="modal-content">
            <h3 id="scan-modal-title">Confirm Attendance</h3>
            <div class="card p-4" style="margin: 20px 0; border:1px solid #ddd;">
                <p><strong>Name:</strong> <span id="scan-res-name">...</span></p>
                <p><strong>Username:</strong> <span id="scan-res-user">...</span></p>
            </div>
            
            <div class="text-left mb-4">
                <!-- Step 1: Main Type Selection -->
                <label style="font-weight:600; display:block; margin-bottom:5px;">Attendance Type:</label>
                <select id="attend-main-type-select">
                    <option value="general">General Attendance</option>
                    <option value="event">Specific Event Attendance</option>
                </select>

                <!-- Branch A: General Category Selection -->
                <div id="general-selector-container" class="mt-2">
                    <label style="font-weight:600; display:block; margin-bottom:5px;">Select Program:</label>
                    <select id="general-cat-select">
                        <option value="prayer">·ã®·å∏·àé·âµ ·àò·à≠·àÉ·åç·â•·à≠ </option>
                        <option value="hymn">·ã®·àò·ãù·àô·à≠ ·àò·à≠·àÉ·åç·â•·à≠ </option>
                        <option value="course">·ã®·äÆ·à≠·àµ ·àò·à≠·àÉ·åç·â•·à≠ </option>
                        <option value="discussion">·ã®·ãç·ã≠·ã≠·âµ ·àò·à≠·àÉ·åç·â•·à≠ </option>
                        <option value="drink">·ã®·ä•·àò·â§·â≥·âΩ·äï ·åΩ·ãã ·àò·à≠·àÉ·åç·â•·à≠ </option>
                    </select>

                    <!-- Branch A-Sub: Course Year Selection (Hidden by default) -->
                    <div id="year-selector-container" class="hidden mt-2">
                        <label style="font-weight:600; display:block; margin-bottom:5px;">Select Year:</label>
                        <select id="year-select">
                            <option value="·ä†·äï·ã∞·äõ ·ä†·àò·âµ">·ä†·äï·ã∞·äõ ·ä†·àò·âµ (First Year)</option>
                            <option value="·àÅ·àà·â∞·äõ ·ä†·àò·âµ">·àÅ·àà·â∞·äõ ·ä†·àò·âµ (Second Year)</option>
                            <option value="·à∂·àµ·â∞·äõ ·ä†·àò·âµ">·à∂·àµ·â∞·äõ ·ä†·àò·âµ (Third Year)</option>
                        </select>
                    </div>
                </div>

                <!-- Branch B: Event Selection (Hidden by default) -->
                <div id="event-selector-container" class="hidden mt-2">
                    <label style="font-weight:600;">Select Event:</label>
                    <select id="scan-event-select"><option value="" disabled selected>Loading Events...</option></select>
                </div>
            </div>

            <div class="flex gap-4">
                <button class="btn btn-danger" onclick="cancelScan()">Cancel</button>
                <button class="btn" onclick="confirmAttendance()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notif-modal" class="hidden modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeNotifModal()">&times;</span>
            <h3 style="color: var(--primary);">üì¢ New Notification</h3>
            <p id="notif-text" class="mt-4">...</p>
            <button class="btn mt-4" onclick="closeNotifModal()">OK</button>
        </div>
    </div>

    <!-- Donation Modal -->
    <div id="donation-modal" class="hidden modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('donation-modal').classList.add('hidden')">&times;</span>
            <h3>Bank Information</h3>
            <div class="card p-4" style="border:1px solid #eee; margin-top:15px;">
                <p><strong>Bank:</strong> <span id="don-modal-bank">...</span></p>
                <p><strong>Account Name:</strong> <span id="don-modal-name">...</span></p>
                <p><strong>Account Number:</strong> <span id="don-modal-num">...</span></p>
                <button class="btn-outline btn-sm mt-4" onclick="copyToClipboard()">üìã Copy Account Number</button>
            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="edit-user-modal" class="hidden modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditUserModal()">&times;</span>
            <h3>Edit User</h3>
            <input type="hidden" id="edit-user-id">
            <div id="edit-user-form-container">
                <!-- Dynamic fields will be injected here -->
            </div>
            <label>New Password</label>
            <input type="text" id="edit-user-pass" placeholder="Leave blank to keep">
            <button class="btn mt-4" onclick="saveEditedUser()">Save Changes</button>
        </div>
    </div>

    <header>
        <div class="logo-area">
            <!-- LOGO IMAGE RESTORED FOR HEADER -->
            <img src="https://z-cdn-media.chatglm.cn/files/af2b52e8-28bb-42d1-8143-70ff395ce21d.png?auth_key=1868311909-954d65bd85e94c1d8b22c71d5e4f1faa-0-680d18d7fe421e862301185b8304a28a" alt="Logo" class="logo-img">
            <div>
                <div class="app-title">Unity Gebigubae</div>
                <div style="font-size: 0.7rem; color: var(--primary);">·ã©·äí·â≤ ·åç·â¢-·åâ·â£·ä§</div>
            </div>
        </div>
    </header>

    <!-- Auth Section -->
    <section id="view-auth" class="card" style="max-width: 450px; margin: 50px auto;">
        <div class="text-center mb-4">
             <!-- LOGO IMAGE RESTORED FOR LOGIN PAGE -->
            <img src="https://z-cdn-media.chatglm.cn/files/af2b52e8-28bb-42d1-8143-70ff395ce21d.png?auth_key=1868311909-954d65bd85e94c1d8b22c71d5e4f1faa-0-680d18d7fe421e862301185b8304a28a" alt="Logo" style="width: 80px; height: 80px;">
        </div>
        <div id="form-login">
            <h2 class="mb-4 text-center">Login</h2>
            <input type="text" id="login-user" placeholder="Username">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn" onclick="handleLogin()">Sign In</button>
            <p class="mt-4 text-center"><span>No account?</span> <a href="#" onclick="toggleAuth('register')" style="color: var(--primary);">Sign Up</a></p>
        </div>
        <div id="form-register" class="hidden">
            <h2 class="mb-4 text-center">Sign Up</h2>
            <div id="register-form-fields">
                <!-- Dynamic fields injected here -->
            </div>
            <button class="btn" onclick="handleRegister()">Register</button>
            <p class="mt-4 text-center"><a href="#" onclick="toggleAuth('login')" style="color: var(--primary);">Back to Login</a></p>
        </div>
    </section>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <main>
            <!-- View: Home -->
            <section id="view-home" class="view-section">
                <div class="quote-box">
                    <h4 id="home-quote-text">‚Äú‚Äπ‚Äπ·â†·åí·â•·ãù·äì·àÖ ·ãà·à´·âµ ·çà·å£·à™·àÖ·äï ·ä†·àµ·â•‚Ä∫‚Ä∫ (·àò·ä≠·â•·â• ·ç≤·ç™·ç•·ç©)‚Äù</h4>
                    <small style="color: var(--secondary); opacity: 0.8;">Remember your Creator in days of your youth</small>
                </div>
                <div class="dashboard-grid">
                    <div class="nav-card" onclick="router('media')"><span class="nav-icon">üì∫</span>Media</div>
                    <div class="nav-card" onclick="router('events')"><span class="nav-icon">üìÖ</span>Events</div>
                    <div class="nav-card" onclick="router('donations')"><span class="nav-icon">‚ù§</span>Donations</div>
                </div>
            </section>

            <!-- View: Media -->
            <section id="view-media" class="view-section hidden">
                <h2 class="mb-4">Media Center</h2>
                <div id="media-feed-container" class="media-feed-wrapper"></div>
            </section>

            <!-- View: Events -->
            <section id="view-events" class="view-section hidden">
                <h2 class="mb-4">Upcoming Events</h2>
                <div id="events-list-container"></div>
            </section>

            <!-- View: Donations -->
            <section id="view-donations" class="view-section hidden">
                <h2 class="mb-4">Donations</h2>
                <div class="card">
                    <h3 id="donation-cause-title">General Support</h3>
                    <p class="mb-4">Current Goal Progress</p>
                    <div style="background:#eee; height:25px; border-radius:12px; overflow:hidden;">
                        <div id="donation-progress-bar" style="width: 0%; background:var(--accent); height:100%; transition: width 0.5s;"></div>
                    </div>
                    <p class="text-right mt-2"><strong id="donation-percent-text">0%</strong> Raised</p>
                    <button class="btn mt-4" onclick="openDonationModal()">Donate Now</button>
                </div>
            </section>

            <!-- View: Profile -->
            <section id="view-profile" class="view-section hidden">
                <h2 class="mb-4">My Profile</h2>
                <div class="card">
                    <div id="profile-form-container">
                        <!-- Dynamic fields -->
                    </div>
                    <label>Change Password</label>
                    <input type="password" id="edit-old-pass" placeholder="Old Password (leave blank to keep)">
                    <input type="password" id="edit-new-pass" placeholder="New Password">
                    <button class="btn mt-4" onclick="updateProfile()">Update Profile</button>
                </div>

                <!-- Generate ID Card Button -->
                <button class="btn btn-outline mt-4" onclick="generateIDCard()">üÜî Generate ID Card (Image)</button>

                <div class="card mt-4">
                    <h3>My Attendance QR</h3>
                    <p class="text-sm text-light mb-2">Show this code for scanning.</p>
                    <div class="qr-display" id="user-qr-code"><span>Loading...</span></div>
                </div>
                <div class="card mt-4">
                    <h3>Attendance History</h3>
                    <div id="attendance-history-list"><p>Loading attendance...</p></div>
                </div>
                <button class="btn btn-danger mt-4" onclick="logout()">Logout</button>
            </section>

            <!-- =========================================
                 ADMIN DASHBOARD
            ========================================= -->
            <section id="view-admin" class="view-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2>Admin Dashboard</h2>
                    <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
                </div>
                
                <div class="admin-tabs">
                    <div class="a-tab active" onclick="switchAdminTab('overview')">Overview</div>
                    <div class="a-tab" onclick="switchAdminTab('user-mgmt')">User Mgmt</div>
                    <div class="a-tab" onclick="switchAdminTab('attendance')">Attendance</div>
                    <div class="a-tab" onclick="switchAdminTab('data')">Data</div>
                    <div class="a-tab" onclick="switchAdminTab('media')">Media</div>
                    <div class="a-tab" onclick="switchAdminTab('events')">Events</div>
                    <div class="a-tab" onclick="switchAdminTab('donations')">Donations</div>
                    <div class="a-tab" onclick="switchAdminTab('form-builder')">Form Builder</div>
                    <div class="a-tab" onclick="switchAdminTab('settings')">Settings</div>
                </div>

                <!-- Overview -->
                <div id="admin-overview" class="admin-section">
                    <div class="dashboard-grid mb-4">
                        <div class="card text-center"><h3>Users</h3><h1 id="stat-users">0</h1></div>
                        <div class="card text-center"><h3>Events</h3><h1 id="stat-events">0</h1></div>
                        <div class="card text-center"><h3>Gen. Att.</h3><h1 id="stat-gen-att">0</h1></div>
                        <div class="card text-center"><h3>Event Att.</h3><h1 id="stat-evt-att">0</h1></div>
                    </div>
                    <button class="btn btn-outline" onclick="exportPDF()">üìÑ Export Full Report (PDF)</button>
                </div>

                <!-- User Management -->
                <div id="admin-user-mgmt" class="admin-section hidden">
                    <div class="card">
                        <h3>Add New User</h3>
                        <div id="admin-add-user-container">
                            <!-- Dynamic fields injected here -->
                        </div>
                        <button class="btn mt-4" onclick="adminAddUser()">Add User</button>
                    </div>

                    <div class="card">
                        <h3>Existing Users</h3>
                        <div class="filter-group">
                            <label>Quick Search (Name or Username)</label>
                            <input type="text" id="admin-user-search" placeholder="Type to filter..." onkeyup="renderUserManagementList()">
                        </div>
                        <div class="table-responsive">
                            <table id="admin-users-table">
                                <thead><tr><th>Name</th><th>Username</th><th>Phone</th><th>Dept</th><th>Batch</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Attendance Scanner -->
                <div id="admin-attendance" class="admin-section hidden">
                    <div class="card">
                        <h3>Attendance Scanner</h3>
                        <p class="mb-4 text-light">Scan User QR Code to record attendance.</p>
                        <div class="flex justify-center mb-4">
                            <button id="btn-start-scan" class="btn" style="width:200px" onclick="startScanner()">üì∑ Start Camera</button>
                            <button id="btn-stop-scan" class="btn btn-danger hidden" style="width:200px" onclick="stopScanner()">‚èπ Stop Camera</button>
                        </div>
                        <div id="reader"></div>
                        <div class="mt-4 p-4" style="background: #f9f9f9; border-radius: 8px;">
                            <h4>Recent Scans</h4>
                            <div id="recent-scans-list" class="text-sm text-light mt-2">No scans yet.</div>
                        </div>
                    </div>
                </div>

                <!-- Data Retrieval (Dynamic Filters & Checkboxes) -->
                <div id="admin-data" class="admin-section hidden">
                    <div class="card">
                        <h3>Data Retrieval & Filtering</h3>
                        
                        <!-- Dynamic Search Filters -->
                        <div class="filter-group">
                            <h4>Search Criteria</h4>
                            <p class="text-sm text-light mb-2">Enter values for fields you want to search by. Leave others empty.</p>
                            <div id="dynamic-filters-container" class="form-grid"></div>
                        </div>

                        <!-- Dynamic Column Checkboxes -->
                        <div class="filter-group">
                            <h4>Select Columns to Display</h4>
                            <div id="dynamic-checkboxes-container" class="checkbox-group"></div>
                        </div>

                        <button class="btn" onclick="retrieveFilteredData()">üîç Retrieve Data</button>
                    </div>
                    <div class="card">
                        <div class="flex justify-between items-center mb-2">
                            <h4>Results</h4>
                            <button class="btn-sm btn-outline" onclick="exportCurrentTable()">üìÑ Export PDF</button>
                        </div>
                        <div id="data-results-container" class="table-responsive">
                            <div class="text-center p-4 text-light">No data retrieved yet.</div>
                        </div>
                    </div>
                </div>

                <!-- Media -->
                <div id="admin-media" class="admin-section hidden">
                    <div class="card">
                        <h3>Add Media</h3>
                        <select id="media-type">
                            <option value="youtube">YouTube</option>
                            <option value="telegram">Telegram Link</option>
                            <option value="tiktok">TikTok</option>
                            <option value="instagram">Instagram</option>
                        </select>
                        <input type="text" id="media-title" placeholder="Title (e.g., Sunday Service)">
                        <input type="text" id="media-url" placeholder="URL Link">
                        <button class="btn" onclick="adminAddMedia()">Add</button>
                    </div>
                    <div class="card"><div class="table-responsive"><table id="media-table"><thead><tr><th>Type</th><th>Title</th><th>Action</th></tr></thead><tbody></tbody></table></div></div>
                </div>

                <!-- Events -->
                <div id="admin-events" class="admin-section hidden">
                    <div class="card">
                        <h3>Create Event</h3>
                        <input type="text" id="evt-title" placeholder="Title">
                        <input type="date" id="evt-date">
                        <input type="text" id="evt-loc" placeholder="Location">
                        <button class="btn" onclick="adminAddEvent()">Create</button>
                    </div>
                    <div class="card"><div class="table-responsive"><table id="events-table"><thead><tr><th>Title</th><th>Date</th><th>Action</th></tr></thead><tbody></tbody></table></div></div>
                </div>

                <!-- Donations -->
                <div id="admin-donations" class="admin-section hidden">
                    <div class="card">
                        <h3>Donation Settings</h3>
                        <label>Cause</label><input type="text" id="don-cause-input">
                        <label>Percent</label><input type="number" id="don-percent-input" max="100">
                        <label>Bank Name</label><input type="text" id="don-bank-input">
                        <label>Account Name</label><input type="text" id="don-acc-name-input">
                        <label>Account Number</label><input type="text" id="don-acc-num-input">
                        <button class="btn mt-4" onclick="adminUpdateDonations()">Update</button>
                    </div>
                </div>

                <!-- FORM BUILDER (CRUD Logic Fixed) -->
                <div id="admin-form-builder" class="admin-section hidden">
                    <div class="card">
                        <h3>Sign Up Form Builder</h3>
                        <p class="text-sm text-light mb-4">Add, Edit, or Delete fields that appear on User Registration page.</p>
                        
                        <div class="form-builder-row">
                            <input type="hidden" id="fb-doc-id">
                            <div style="flex:2">
                                <label>Label Text</label>
                                <input type="text" id="fb-label" placeholder="e.g. Father's Name">
                            </div>
                            <div style="flex:1">
                                <label>Field ID (Key)</label>
                                <input type="text" id="fb-id" placeholder="e.g. father">
                            </div>
                            <div style="flex:1">
                                <label>Type</label>
                                <select id="fb-type" onchange="toggleFbOptions()">
                                    <option value="text">Text</option>
                                    <option value="tel">Phone</option>
                                    <option value="select">Dropdown</option>
                                    <option value="date">Date</option>
                                    <option value="password">Password</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="fb-options-container" class="hidden mb-4">
                            <label>Options (Comma separated)</label>
                            <input type="text" id="fb-options" placeholder="Option A, Option B, Option C">
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="fb-required" style="width:auto; margin:0;"> Required Field
                            </label>
                            <button id="fb-save-btn" class="btn btn-sm" onclick="adminSaveFormField()">+ Add Field</button>
                        </div>

                        <h4>Current Fields</h4>
                        <div id="form-fields-list">
                            <div class="text-center text-light p-4">Loading fields...</div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div id="admin-settings" class="admin-section hidden">
                    <div class="card">
                        <h3>Admin Authentication</h3>
                        <label>New Username</label><input type="text" id="admin-username-update">
                        <label>New Password</label><input type="password" id="admin-pass-update">
                        <button class="btn btn-danger mt-2" onclick="updateAdminCredentials()">Update Admin Credentials</button>
                    </div>
                    <div class="card mt-4">
                        <h3>Send Notification</h3>
                        <textarea id="notif-input" rows="3" placeholder="Type notification message..."></textarea>
                        <button class="btn" onclick="adminSendNotification()">Send Alert</button>
                    </div>
                    <div class="card">
                        <h3>Home Quote</h3>
                        <input type="text" id="quote-text-input">
                        <button class="btn" onclick="adminUpdateQuote()">Update Quote</button>
                    </div>
                </div>

            </section>
        </main>

        <!-- Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="router('home')"><span class="nav-icon-bottom">üè†</span> Home</button>
            <button class="nav-item" onclick="router('media')"><span class="nav-icon-bottom">üì∫</span> Media</button>
            <button class="nav-item" onclick="router('events')"><span class="nav-icon-bottom">üìÖ</span> Events</button>
            <button class="nav-item" onclick="router('donations')"><span class="nav-icon-bottom">‚ù§</span> Donations</button>
            <button class="nav-item" onclick="router('profile')"><span class="nav-icon-bottom">üë§</span> Profile</button>
        </nav>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, setDoc, getDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBehnqMCD15AppaeLVR75EUWGBflGGUqeg",
          authDomain: "unitygbigubae.firebaseapp.com",
          projectId: "unitygbigubae",
          storageBucket: "unitygbigubae.firebasestorage.app",
          messagingSenderId: "420269799160",
          appId: "1:420269799160:web:89f59c0ff9ebe4af7ced0d",
          measurementId: "G-Z8NR9862HJ"
        };

        // Initialize Firebase
        let db;
        let html5QrcodeScanner = null;
        let scannedUserRef = null;
        let currentExportData = [];
        let formSchema = []; // Global cache for form fields

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected Successfully");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        let currentUser = null;
        let isAdmin = false;

        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function ensureAdminExists() {
            const adminRef = doc(db, "admin_auth", "main");
            const docSnap = await getDoc(adminRef);
            if (!docSnap.exists()) {
                const defaultPassHash = await hashPassword("admin123");
                await setDoc(adminRef, { username: "admin", passwordHash: defaultPassHash });
            }
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.style.cssText = "position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:2000; animation: fadeIn 0.3s;";
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function getYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|shorts\/)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : null;
        }

        function getTikTokDetails(url) {
            const regExp = /tiktok\.com\/@([^\/]+)\/(video|v)\/(\d+)/;
            const match = url.match(regExp);
            return match ? { username: match[1], id: match[3] } : null;
        }

        function getInstagramId(url) {
            const regExp = /instagram\.com\/(?:p|reel)\/([^/?]+)/;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }

        // --- DYNAMIC FORM SYSTEM ---
        
        async function seedDefaultFormFields() {
            const snap = await getDocs(query(collection(db, "form_fields"), orderBy("order")));
            if (!snap.empty) return; 

            console.log("Seeding default form fields...");
            const defaults = [
                { label: "Full Name", id: "name", type: "text", required: true, order: 1 },
                { label: "Father's Name", id: "father", type: "text", required: false, order: 2 },
                { label: "Grandfather's Name", id: "grand", type: "text", required: false, order: 3 },
                { label: "Phone Number", id: "phone", type: "tel", required: true, order: 4 },
                { label: "Username", id: "username", type: "text", required: true, order: 5 },
                { label: "Password", id: "password", type: "password", required: true, order: 6 },
                { label: "Department", id: "dept", type: "select", options: "Computer Science,Accounting,Civil Engineering,Sociology,Management,Marketing Management,Nursing,Other", required: true, order: 7 },
                { label: "Batch", id: "batch", type: "select", options: "Auto", required: true, order: 8 } 
            ];

            for(const f of defaults) {
                await addDoc(collection(db, "form_fields"), f);
            }
        }

        async function loadFormSchema() {
            const snap = await getDocs(query(collection(db, "form_fields"), orderBy("order")));
            formSchema = [];
            snap.forEach(d => {
                formSchema.push({ ...d.data(), docId: d.id });
            });
        }

        function renderFormFields(containerId, values = {}, prefix = "reg-") {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            formSchema.forEach(field => {
                const wrapper = document.createElement('div');
                
                const label = document.createElement('label');
                label.textContent = field.label + (field.required ? " *" : "");
                wrapper.appendChild(label);

                if (field.id === 'batch' && field.type === 'select') {
                    const sel = document.createElement('select');
                    sel.id = prefix + field.id;
                    sel.required = field.required;
                    if(values[field.id]) sel.value = values[field.id];
                    const currentYear = new Date().getFullYear();
                    for(let i = 2000; i <= currentYear + 8; i++){
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = i;
                        sel.appendChild(opt);
                    }
                    wrapper.appendChild(sel);
                } else if (field.type === 'select') {
                    const sel = document.createElement('select');
                    sel.id = prefix + field.id;
                    sel.required = field.required;
                    if(values[field.id]) sel.value = values[field.id];
                    if(field.options) {
                        field.options.split(',').forEach(optText => {
                            const opt = document.createElement('option');
                            opt.value = optText.trim();
                            opt.textContent = optText.trim();
                            sel.appendChild(opt);
                        });
                    }
                    wrapper.appendChild(sel);
                } else {
                    const inp = document.createElement('input');
                    inp.type = field.type;
                    inp.id = prefix + field.id;
                    inp.placeholder = field.label;
                    inp.required = field.required;
                    if(values[field.id]) inp.value = values[field.id];
                    wrapper.appendChild(inp);
                }
                container.appendChild(wrapper);
            });
        }

        window.toggleFbOptions = () => {
            const type = document.getElementById('fb-type').value;
            document.getElementById('fb-options-container').classList.toggle('hidden', type !== 'select');
        };

        // --- FORM BUILDER CRUD LOGIC (FIXED RENDER CALL) ---

        window.adminEditFormField = (docId) => {
            const field = formSchema.find(f => f.docId === docId);
            if(!field) return;
            
            // Populate inputs
            document.getElementById('fb-doc-id').value = docId;
            document.getElementById('fb-label').value = field.label;
            document.getElementById('fb-id').value = field.id;
            document.getElementById('fb-type').value = field.type;
            document.getElementById('fb-options').value = field.options || '';
            document.getElementById('fb-required').checked = field.required;
            
            toggleFbOptions();
            
            // UI Change
            const btn = document.getElementById('fb-save-btn');
            btn.textContent = "Update Field";
            btn.style.backgroundColor = '#e67e22'; 
            btn.style.color = 'white';
        };

        window.resetFormBuilder = () => {
            document.getElementById('fb-doc-id').value = '';
            document.getElementById('fb-label').value = '';
            document.getElementById('fb-id').value = '';
            document.getElementById('fb-options').value = '';
            document.getElementById('fb-required').checked = false;
            
            const btn = document.getElementById('fb-save-btn');
            btn.textContent = "+ Add Field";
            btn.style.backgroundColor = '';
            btn.style.color = '';
        };

        window.adminSaveFormField = async () => {
            const docId = document.getElementById('fb-doc-id').value;
            const label = document.getElementById('fb-label').value;
            const id = document.getElementById('fb-id').value.trim();
            const type = document.getElementById('fb-type').value;
            const options = document.getElementById('fb-options').value;
            const required = document.getElementById('fb-required').checked;

            if(!label || !id) return showToast("Label and ID are required");

            // Check ID uniqueness (skip check if we are editing SAME ID)
            const idConflict = formSchema.find(f => f.id === id && f.docId !== docId);
            if(idConflict) return showToast("Field ID must be unique");

            const data = { label, id, type, options, required };

            if(docId) {
                // UPDATE
                await updateDoc(doc(db, "form_fields", docId), data);
                showToast("Field Updated!");
            } else {
                // CREATE
                const order = formSchema.length + 1;
                await addDoc(collection(db, "form_fields"), { ...data, order });
                showToast("Field Added");
            }
            
            resetFormBuilder();
            await loadFormSchema(); 
            renderFormBuilderList(); 
        };

        window.adminDeleteFormField = async (docId) => {
            if(confirm("Delete this field? It will be removed from registration form.")) {
                await deleteDoc(doc(db, "form_fields", docId));
                showToast("Field Deleted");
                await loadFormSchema();
                renderFormBuilderList();
            }
        };

        function renderFormBuilderList() {
            const list = document.getElementById('form-fields-list');
            list.innerHTML = '';
            if(formSchema.length === 0) {
                list.innerHTML = '<div class="text-center text-light p-4">No fields defined yet.</div>';
                return;
            }

            formSchema.forEach(f => {
                const div = document.createElement('div');
                div.className = 'field-item';
                div.innerHTML = `
                    <div>
                        <strong>${f.label}</strong> <small>(${f.id})</small><br>
                        <span class="text-light" style="font-size:0.8rem">${f.type} ${f.required ? '| Required' : ''}</span>
                    </div>
                    <div>
                        <button class="btn-sm btn-outline" style="margin-right:5px;" onclick="adminEditFormField('${f.docId}')">Edit</button>
                        <button class="btn-sm btn-danger" onclick="adminDeleteFormField('${f.docId}')">Del</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }


        // --- MAIN APP LOGIC ---

        window.onload = async () => {
             await ensureAdminExists();
             await seedDefaultFormFields(); 
             await loadFormSchema(); 

             const savedUser = localStorage.getItem('ug_user_session');
             if (savedUser) {
                 currentUser = JSON.parse(savedUser);
                 isAdmin = currentUser.isAdmin || false;
                 showApp();
             } else {
                 document.getElementById('view-auth').classList.remove('hidden');
             }

             // LISTENER FOR MAIN ATTENDANCE TYPE (General vs Event)
             document.getElementById('attend-main-type-select').addEventListener('change', (e) => {
                 const generalDiv = document.getElementById('general-selector-container');
                 const eventDiv = document.getElementById('event-selector-container');
                 
                 if(e.target.value === 'general') {
                     generalDiv.classList.remove('hidden');
                     eventDiv.classList.add('hidden');
                 } else {
                     generalDiv.classList.add('hidden');
                     eventDiv.classList.remove('hidden');
                     loadEventsIntoModal();
                 }
             });

             // LISTENER FOR GENERAL CATEGORY (Course Year Logic)
             document.getElementById('general-cat-select').addEventListener('change', (e) => {
                 const yearDiv = document.getElementById('year-selector-container');
                 if(e.target.value === 'course') {
                     yearDiv.classList.remove('hidden');
                 } else {
                     yearDiv.classList.add('hidden');
                 }
             });
        };

        window.toggleAuth = (mode) => {
            document.getElementById('form-login').classList.toggle('hidden', mode !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', mode !== 'register');
            if(mode === 'register') {
                renderFormFields('register-form-fields', {}, 'reg-');
            }
        };

        window.handleLogin = async () => {
            const username = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            if (!username || !pass) return showToast("Please enter username and password");

            const adminRef = doc(db, "admin_auth", "main");
            const adminSnap = await getDoc(adminRef);
            const passHash = await hashPassword(pass);

            if (adminSnap.exists()) {
                const adminData = adminSnap.data();
                if (username === adminData.username && passHash === adminData.passwordHash) {
                    currentUser = { username: "Admin", isAdmin: true };
                    isAdmin = true;
                    localStorage.setItem('ug_user_session', JSON.stringify(currentUser));
                    showApp();
                    return;
                }
            }

            const q = query(collection(db, "users"), where("username", "==", username));
            const querySnapshot = await getDocs(q);
            let foundUser = null;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.passwordHash === passHash) foundUser = { ...data, id: doc.id };
            });

            if (foundUser) {
                currentUser = foundUser;
                isAdmin = false;
                localStorage.setItem('ug_user_session', JSON.stringify(currentUser));
                showApp();
            } else {
                showToast("Invalid Username or Password");
            }
        };

        window.handleRegister = async () => {
            const newData = {};
            let isValid = true;

            for(const field of formSchema) {
                const el = document.getElementById('reg-' + field.id);
                if(!el) continue;
                
                const val = el.value.trim();
                if(field.required && !val) {
                    showToast(`${field.label} is required`);
                    isValid = false;
                    break;
                }
                
                if(field.type === 'password') {
                    newData['passwordHash'] = await hashPassword(val);
                } else {
                    newData[field.id] = val;
                }
            }

            if(!isValid) return;

            if(newData.username) {
                const q = query(collection(db, "users"), where("username", "==", newData.username));
                const snap = await getDocs(q);
                if(!snap.empty) return showToast("Username already taken");
            }

            await addDoc(collection(db, "users"), { 
                ...newData, 
                createdAt: new Date().toISOString() 
            });
            showToast("Registration Successful!");
            toggleAuth('login');
        };

        window.logout = () => {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('ug_user_session');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('view-auth').classList.remove('hidden');
            stopScanner();
        };

        window.router = (view) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navBtn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.getAttribute('onclick')?.includes(view));
            if (navBtn) navBtn.classList.add('active');

            if (view === 'profile' && !isAdmin) {
                renderFormFields('profile-form-container', currentUser, 'edit-');
                loadAttendanceHistory();
            }
            if (view === 'media' && !isAdmin) loadUserMedia();
            if (view !== 'admin' && (html5QrcodeScanner && html5QrcodeScanner.isScanning)) {
                stopScanner();
            }
        };

        async function showApp() {
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            const nav = document.querySelector('.bottom-nav');
            const existingAdminBtn = document.getElementById('nav-admin');
            if (existingAdminBtn) existingAdminBtn.remove();

            if (isAdmin) {
                const btn = document.createElement('button');
                btn.className = 'nav-item';
                btn.id = 'nav-admin';
                btn.innerHTML = '<span class="nav-icon-bottom">‚öôÔ∏è</span> Admin';
                btn.onclick = () => router('admin');
                nav.appendChild(btn);
                loadAdminDashboard();
                checkAdminNotifications();
                renderUserManagementList(); 
                renderFormBuilderList(); 

                const adminRef = doc(db, "admin_auth", "main");
                const snap = await getDoc(adminRef);
                if(snap.exists()) document.getElementById('admin-username-update').value = snap.data().username;

            } else {
                loadUserNotifications();
                loadUserMedia();
                loadUserEvents();
                loadDonations();
                
                const qrData = `${currentUser.username}-${currentUser.id}`;
                document.getElementById('user-qr-code').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}" alt="QR">`;
            }
            router('home');
        }

        window.generateIDCard = async () => {
            if(!currentUser) return showToast("User data not found");

            showToast("Generating ID Card...");

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 1010; 
            const height = 638; 
            canvas.width = width;
            canvas.height = height;

            ctx.fillStyle = '#2c3e50'; 
            ctx.fillRect(0, 0, width, height);

            ctx.fillStyle = '#F9B233';
            ctx.fillRect(0, 0, width, 15);
            ctx.fillRect(0, height - 15, width, 15);

            ctx.textAlign = 'center';
            ctx.fillStyle = '#F9B233'; 
            ctx.font = 'bold 50px "Noto Sans Ethiopic", sans-serif'; 
            ctx.fillText("·ã©·äí·â≤ ·åç·â¢-·åâ·â£·ä§", width / 2, 130);

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 30px Poppins, sans-serif';
            ctx.fillText("UNITY GEBIGUBAE", width / 2, 180);
            ctx.font = 'italic 18px Poppins, sans-serif';
            ctx.fillText("Official Member ID", width / 2, 205);

            ctx.strokeStyle = '#F9B233';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(100, 230);
            ctx.lineTo(width - 100, 230);
            ctx.stroke();

            ctx.textAlign = 'left';
            ctx.font = '28px Arial';
            let yPos = 300;
            const leftMargin = 80;
            const lineHeight = 40;

            const displayFields = [
                { label: "Name", val: currentUser.name },
                { label: "Father", val: currentUser.father },
                { label: "Dept", val: currentUser.dept },
                { label: "Batch", val: currentUser.batch },
            ];

            displayFields.forEach(item => {
                if(item.val) {
                    ctx.fillStyle = '#F9B233';
                    ctx.fillText(item.label + ":", leftMargin, yPos);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(item.val, leftMargin + 100, yPos);
                    yPos += lineHeight;
                }
            });

            const qrData = `${currentUser.username}-${currentUser.id}`;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;
            
            try {
                const qrImg = await loadImage(qrApiUrl);
                const qrSize = 180;
                const qrX = width - qrSize - 60;
                const qrY = height - qrSize - 60;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(qrX - 5, qrY - 5, qrSize + 10, qrSize + 10);
                ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);
                
                ctx.fillStyle = '#aaaaaa';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText("SCAN FOR VERIFICATION", qrX + qrSize/2, qrY + qrSize + 25);
            } catch (err) {
                console.error("QR Failed", err);
            }

            try {
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${currentUser.username}_ID_Card.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("ID Card Image Saved!");
            } catch (e) {
                console.error(e);
                showToast("Error generating image");
            }
        };

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = (e) => reject(e);
            });
        }

        window.adminAddUser = async () => {
            const newData = {};
            let isValid = true;
            const prefix = 'admin-add-';

            for(const field of formSchema) {
                const el = document.getElementById(prefix + field.id);
                if(!el) continue;
                const val = el.value.trim();
                
                if(field.required && !val) {
                    showToast(`${field.label} is required`);
                    isValid = false;
                    break;
                }
                
                if(field.type === 'password') {
                    newData['passwordHash'] = await hashPassword(val);
                } else {
                    newData[field.id] = val;
                }
            }
            if(!isValid) return;

            if(newData.username) {
                const q = query(collection(db, "users"), where("username", "==", newData.username));
                const snap = await getDocs(q);
                if(!snap.empty) return showToast("Username taken");
            }

            await addDoc(collection(db, "users"), newData);
            showToast("User Added Successfully");
            
            formSchema.forEach(f => {
                const el = document.getElementById(prefix + f.id);
                if(el) el.value = '';
            });

            renderUserManagementList();
            loadAdminDashboard();
        };

        window.renderUserManagementList = async () => {
            const search = document.getElementById('admin-user-search').value.toLowerCase();
            const tbody = document.querySelector('#admin-users-table tbody');
            tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            tbody.innerHTML = '';

            snap.forEach(d => {
                const u = d.data();
                if(search && !u.name.toLowerCase().includes(search) && !u.username.toLowerCase().includes(search)) return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.name}</td>
                    <td>${u.username}</td>
                    <td>${u.phone}</td>
                    <td>${u.dept}</td>
                    <td>${u.batch}</td>
                    <td>
                        <button class="btn-sm btn-outline" onclick="openEditUserModal('${d.id}')">Edit</button>
                        <button class="btn-sm btn-danger" onclick="adminDeleteUser('${d.id}')">Del</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.openEditUserModal = async (userId) => {
            const userDoc = await getDoc(doc(db, "users", userId));
            if(userDoc.exists()) {
                const u = userDoc.data();
                document.getElementById('edit-user-id').value = userId;
                renderFormFields('edit-user-form-container', u, 'edit-user-');
                document.getElementById('edit-user-modal').classList.remove('hidden');
            }
        };

        window.closeEditUserModal = () => {
            document.getElementById('edit-user-modal').classList.add('hidden');
        };

        window.saveEditedUser = async () => {
            const userId = document.getElementById('edit-user-id').value;
            const newPass = document.getElementById('edit-user-pass').value;
            const updateData = {};
            const prefix = 'edit-user-';

            for(const field of formSchema) {
                const el = document.getElementById(prefix + field.id);
                if(el) {
                    if (field.id === 'password') continue; 
                    updateData[field.id] = el.value;
                }
            }

            if(newPass) {
                updateData.passwordHash = await hashPassword(newPass);
            }
            
            await updateDoc(doc(db, "users", userId), updateData);
            showToast("User Updated");
            closeEditUserModal();
            renderUserManagementList();
        };

        window.adminDeleteUser = async (userId) => {
            if(confirm("Are you sure you want to delete this user?")) {
                await deleteDoc(doc(db, "users", userId));
                showToast("User Deleted");
                renderUserManagementList();
                loadAdminDashboard();
            }
        };

        async function calculateAttendanceData(usersSnap) {
            const genAtt = await getDocs(collection(db, "attendance_general"));
            const evtAtt = await getDocs(collection(db, "attendance_events"));
            
            const counts = {}; 
            
            genAtt.forEach(d => {
                const uid = d.data().userId;
                const dateStr = new Date(d.data().timestamp.toDate()).toDateString();
                if(!counts[uid]) counts[uid] = { gen: new Set(), evt: new Set() };
                counts[uid].gen.add(dateStr);
            });

            evtAtt.forEach(d => {
                const uid = d.data().userId;
                const dateStr = new Date(d.data().timestamp.toDate()).toDateString();
                if(!counts[uid]) counts[uid] = { gen: new Set(), evt: new Set() };
                counts[uid].evt.add(dateStr);
            });

            const result = [];
            usersSnap.forEach(uDoc => {
                const u = uDoc.data();
                const c = counts[uDoc.id] || { gen: new Set(), evt: new Set() };
                result.push({
                    ...u,
                    id: uDoc.id,
                    genDays: c.gen.size,
                    evtDays: c.evt.size,
                    totalDays: c.gen.size + c.evt.size
                });
            });
            return result;
        }

        window.retrieveFilteredData = async () => {
            const container = document.getElementById('data-results-container');
            container.innerHTML = '<div class="text-center p-4">Retrieving Data...</div>';

            // 1. Gather Search Criteria from dynamic inputs
            const searchCriteria = {};
            let hasSearch = false;
            formSchema.forEach(field => {
                const el = document.getElementById('search-' + field.id);
                if(el && el.value.trim() !== '') {
                    searchCriteria[field.id] = el.value.trim().toLowerCase();
                    hasSearch = true;
                }
            });

            // 2. Gather Checked Columns
            const checkedFields = formSchema.filter(f => {
                const chk = document.getElementById('chk-' + f.id);
                return chk && chk.checked;
            });

            // 3. Fetch & Filter Users
            const usersSnap = await getDocs(collection(db, "users"));
            let filteredUsers = [];
            usersSnap.forEach(d => {
                const u = { ...d.data(), id: d.id };
                
                // Apply Search Filters
                let match = true;
                for(const key in searchCriteria) {
                    const val = u[key] ? u[key].toLowerCase() : "";
                    if(!val.includes(searchCriteria[key])) {
                        match = false;
                        break;
                    }
                }
                if(match) filteredUsers.push(u);
            });

            // 4. Add Attendance Data
            const usersWithAtt = await calculateAttendanceData(usersSnap);
            // Map attendance back to filtered users
            const attMap = {};
            usersWithAtt.forEach(u => attMap[u.id] = u);
            
            const finalData = filteredUsers.map(u => ({
                ...u,
                genDays: (attMap[u.id] ? attMap[u.id].genDays : 0),
                evtDays: (attMap[u.id] ? attMap[u.id].evtDays : 0),
                totalDays: (attMap[u.id] ? attMap[u.id].totalDays : 0)
            }));

            // 5. Build Table
            if(finalData.length === 0) {
                container.innerHTML = '<div class="text-center p-4">No matching records found.</div>';
                currentExportData = null;
                return;
            }

            // Table Header
            let html = `<table><thead><tr>`;
            checkedFields.forEach(f => {
                html += `<th>${f.label}</th>`;
            });
            html += `<th>Gen Days</th><th>Event Days</th><th>Total</th></tr></thead><tbody>`;
            
            // Table Body
            finalData.forEach(u => {
                html += `<tr>`;
                checkedFields.forEach(f => {
                    html += `<td>${u[f.id] || '-'}</td>`;
                });
                html += `<td>${u.genDays}</td><td>${u.evtDays}</td><td style="font-weight:bold; color:var(--accent)">${u.totalDays}</td>`;
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;

            // Prepare for Export (Include all checked fields + standard att fields)
            currentExportData = {
                title: "Filtered Data Report",
                headers: checkedFields.map(f => f.label).concat(["Gen Days", "Event Days", "Total"]),
                rows: finalData.map(u => 
                    checkedFields.map(f => u[f.id] || '-').concat([u.genDays, u.evtDays, u.totalDays])
                )
            };
        };

        window.exportCurrentTable = () => {
            if(!currentExportData || currentExportData.rows.length === 0) return showToast("No data to export");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(currentExportData.title, 14, 20);
            doc.autoTable(currentExportData.headers, currentExportData.rows, { startY: 30 });
            doc.save(`Filtered_Data_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast("PDF Downloaded");
        };

        window.startScanner = () => {
            if(html5QrcodeScanner && html5QrcodeScanner.isScanning) return;
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .then(() => {
                document.getElementById('btn-start-scan').classList.add('hidden');
                document.getElementById('btn-stop-scan').classList.remove('hidden');
                showToast("Scanner Active.");
            }).catch(err => showToast("Camera error"));
        };
        window.stopScanner = () => {
            if(html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('btn-start-scan').classList.remove('hidden');
                    document.getElementById('btn-stop-scan').classList.add('hidden');
                });
            }
        };
        async function onScanSuccess(decodedText) {
            stopScanner();
            const parts = decodedText.split('-');
            if (parts.length < 2) { showToast("Invalid QR"); startScanner(); return; }
            const userSnap = await getDoc(doc(db, "users", parts[1].trim()));
            if (userSnap.exists()) {
                scannedUserRef = { id: userSnap.id, ...userSnap.data() };
                document.getElementById('scan-res-name').textContent = scannedUserRef.name;
                document.getElementById('scan-res-user').textContent = scannedUserRef.username;
                
                // Reset Modal Selections
                document.getElementById('attend-main-type-select').value = "general";
                document.getElementById('general-selector-container').classList.remove('hidden');
                document.getElementById('event-selector-container').classList.add('hidden');
                document.getElementById('year-selector-container').classList.add('hidden');
                
                document.getElementById('scan-result-modal').classList.remove('hidden');
            } else {
                showToast("User not found"); startScanner();
            }
        }
        function onScanFailure(error) {}
        window.cancelScan = () => {
            document.getElementById('scan-result-modal').classList.add('hidden');
            scannedUserRef = null;
            startScanner();
        };
        async function loadEventsIntoModal() {
            const select = document.getElementById('scan-event-select');
            select.innerHTML = '<option value="" disabled selected>Select Event</option>';
            const snap = await getDocs(collection(db, "events"));
            snap.forEach(d => {
                const e = d.data();
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = e.title;
                select.appendChild(opt);
            });
        }
        window.confirmAttendance = async () => {
            if (!scannedUserRef) return;
            const type = document.getElementById('attend-main-type-select').value;
            
            if (type === 'general') {
                // General Logic with Categories
                const catSelect = document.getElementById('general-cat-select');
                const yearSelect = document.getElementById('year-select');
                
                let categoryText = catSelect.options[catSelect.selectedIndex].text; // Full Amharic text
                let catValue = catSelect.value;

                // If Course selected, append year
                if(catValue === 'course') {
                    const yearText = yearSelect.options[yearSelect.selectedIndex].text;
                    categoryText = categoryText + " - " + yearText;
                }

                await addDoc(collection(db, "attendance_general"), { 
                    userId: scannedUserRef.id, 
                    category: categoryText, // Store the full description
                    timestamp: new Date() 
                });
            } else {
                // Event Logic
                const eventId = document.getElementById('scan-event-select').value;
                if(!eventId) return showToast("Select event");
                const evtTitle = document.getElementById('scan-event-select').options[document.getElementById('scan-event-select').selectedIndex].text;
                await addDoc(collection(db, "attendance_events"), { userId: scannedUserRef.id, eventId, eventTitle: evtTitle, timestamp: new Date() });
            }
            const list = document.getElementById('recent-scans-list');
            
            // Construct display text
            let displayType = type === 'general' ? "General" : "Event";
            if(type === 'general') {
                 const catSelect = document.getElementById('general-cat-select');
                 const yearSelect = document.getElementById('year-select');
                 let catName = catSelect.options[catSelect.selectedIndex].text.split('(')[0].trim(); // Shorten display
                 if(catSelect.value === 'course') {
                     catName += ` (${yearSelect.value})`;
                 }
                 displayType = catName;
            } else {
                displayType = document.getElementById('scan-event-select').value;
            }

            list.innerHTML = `<div>‚úî ${scannedUserRef.name} <span style="color:var(--primary)">(${displayType})</span></div>` + list.innerHTML;
            showToast("Attendance Recorded");
            document.getElementById('scan-result-modal').classList.add('hidden');
            scannedUserRef = null;
            startScanner();
            loadAdminDashboard();
        };

        // --- FIXED TAB SWITCH LOGIC ---
        window.switchAdminTab = (tab) => {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('admin-' + tab).classList.remove('hidden');
            document.querySelectorAll('.a-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            stopScanner();

            if(tab === 'user-mgmt') {
                renderFormFields('admin-add-user-container', {}, 'admin-add-');
                renderUserManagementList();
            }
            
            if(tab === 'data') {
                renderDataFiltersAndCheckboxes();
                document.getElementById('data-results-container').innerHTML = '<div class="text-center p-4 text-light">No data retrieved yet.</div>';
            }

            // FIX: Force refresh when entering Form Builder
            if(tab === 'form-builder') {
                renderFormBuilderList();
            }
        };

        function renderDataFiltersAndCheckboxes() {
            const filterContainer = document.getElementById('dynamic-filters-container');
            const checkContainer = document.getElementById('dynamic-checkboxes-container');
            
            filterContainer.innerHTML = '';
            checkContainer.innerHTML = '';

            formSchema.forEach(field => {
                // Skip password fields for search/display usually
                if(field.type === 'password') return;

                // 1. Create Search Input
                const wrapper = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = field.label;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'search-' + field.id;
                input.placeholder = 'Search ' + field.label;
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                filterContainer.appendChild(wrapper);

                // 2. Create Checkbox
                const checkWrapper = document.createElement('div');
                checkWrapper.className = 'checkbox-label';
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.id = 'chk-' + field.id;
                chk.checked = true; 
                chk.value = field.id;
                
                const chkLabel = document.createElement('span');
                chkLabel.textContent = field.label;

                checkWrapper.appendChild(chk);
                checkWrapper.appendChild(chkLabel);
                checkContainer.appendChild(checkWrapper);
            });
        }

        window.adminAddMedia = async () => {
            const type = document.getElementById('media-type').value;
            const title = document.getElementById('media-title').value;
            const url = document.getElementById('media-url').value;
            if(!title || !url) return showToast("Required fields missing");
            if(type === 'tiktok') {
                const details = getTikTokDetails(url);
                if (!details) return showToast("Invalid TikTok");
                if(details.username.toLowerCase() !== 'unitygebigubae') {
                    return alert(`TikTok video must be from @UnityGebiguba.`);
                }
            }
            if(type === 'youtube' && !getYouTubeId(url)) return showToast("Invalid YouTube");
            if(type === 'instagram' && !getInstagramId(url)) return showToast("Invalid Insta");
            await addDoc(collection(db, "media"), { type, title, url });
            showToast("Media Added");
            renderAdminTables();
            document.getElementById('media-title').value = ''; document.getElementById('media-url').value = '';
        };
        window.deleteMedia = async (id) => {
            if(confirm("Delete?")) { await deleteDoc(doc(db, "media", id)); renderAdminTables(); }
        };
        window.adminAddEvent = async () => {
            const title = document.getElementById('evt-title').value;
            const date = document.getElementById('evt-date').value;
            const loc = document.getElementById('evt-loc').value;
            if(!title || !date) return;
            await addDoc(collection(db, "events"), { title, date, location: loc });
            showToast("Event Created");
            renderAdminTables();
            document.getElementById('evt-title').value = '';
        };
        window.deleteEvent = async (id) => {
            if(confirm("Delete?")) { await deleteDoc(doc(db, "events", id)); renderAdminTables(); }
        };
        window.adminUpdateDonations = async () => {
            const data = {
                cause: document.getElementById('don-cause-input').value,
                percent: document.getElementById('don-percent-input').value,
                bank: document.getElementById('don-bank-input').value,
                accName: document.getElementById('don-acc-name-input').value,
                accNum: document.getElementById('don-acc-num-input').value
            };
            await setDoc(doc(db, "settings", "donations"), data);
            showToast("Donation Info Updated");
        };
        window.adminUpdateQuote = async () => {
            const txt = document.getElementById('quote-text-input').value;
            await setDoc(doc(db, "settings", "general"), { quote: txt });
            document.getElementById('home-quote-text').textContent = txt;
            showToast("Quote Updated");
        };
        window.adminSendNotification = async () => {
            const msg = document.getElementById('notif-input').value;
            if(!msg) return;
            await addDoc(collection(db, "notifications"), { message: msg, timestamp: new Date(), seenBy: [] });
            showToast("Notification Sent!");
            document.getElementById('notif-input').value = '';
        };
        window.updateAdminCredentials = async () => {
            const user = document.getElementById('admin-username-update').value.trim();
            const pass = document.getElementById('admin-pass-update').value.trim();
            if(!user || !pass) return showToast("Fields cannot be empty");
            const passHash = await hashPassword(pass);
            await setDoc(doc(db, "admin_auth", "main"), { username: user, passwordHash: passHash });
            showToast("Admin Credentials Updated Successfully!");
            document.getElementById('admin-pass-update').value = "";
        };

        async function loadAdminDashboard() {
            const usersSnap = await getDocs(collection(db, "users"));
            document.getElementById('stat-users').textContent = usersSnap.size;
            const evtSnap = await getDocs(collection(db, "events"));
            document.getElementById('stat-events').textContent = evtSnap.size;
            const genAttSnap = await getDocs(collection(db, "attendance_general"));
            document.getElementById('stat-gen-att').textContent = genAttSnap.size;
            const evtAttSnap = await getDocs(collection(db, "attendance_events"));
            document.getElementById('stat-evt-att').textContent = evtAttSnap.size;

            const donSnap = await getDoc(doc(db, "settings", "donations"));
            if(donSnap.exists()) {
                const d = donSnap.data();
                document.getElementById('don-cause-input').value = d.cause;
                document.getElementById('don-percent-input').value = d.percent;
                document.getElementById('don-bank-input').value = d.bank || '';
                document.getElementById('don-acc-name-input').value = d.accName || '';
                document.getElementById('don-acc-num-input').value = d.accNum || '';
            }
            const quoteSnap = await getDoc(doc(db, "settings", "general"));
            if(quoteSnap.exists() && quoteSnap.data().quote) {
                document.getElementById('quote-text-input').value = quoteSnap.data().quote;
            }
            renderAdminTables();
        }
        function renderAdminTables() {
            getDocs(collection(db, "media")).then(snap => {
                const mediaBody = document.querySelector('#media-table tbody');
                mediaBody.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    mediaBody.innerHTML += `<tr><td>${data.type}</td><td>${data.title}</td><td><button class="btn-sm btn-danger" onclick="window.deleteMedia('${d.id}')">Del</button></td></tr>`;
                });
            });
            getDocs(collection(db, "events")).then(snap => {
                const evtBody = document.querySelector('#events-table tbody');
                evtBody.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    evtBody.innerHTML += `<tr><td>${data.title}</td><td>${data.date}</td><td><button class="btn-sm btn-danger" onclick="window.deleteEvent('${d.id}')">Del</button></td></tr>`;
                });
            });
        }
        
        async function loadUserMedia() {
            const snap = await getDocs(collection(db, "media"));
            const container = document.getElementById('media-feed-container');
            container.innerHTML = '';
            if (snap.empty) { container.innerHTML = '<div class="card text-center"><p>No media yet.</p></div>'; return; }
            snap.forEach(doc => {
                const data = doc.data();
                const card = document.createElement('div'); card.className = 'media-card';
                if(data.type === 'youtube') {
                    const id = getYouTubeId(data.url);
                    if(id) card.innerHTML = `<div class="media-header">${data.title}</div><div class="responsive-iframe-container video-16-9"><iframe src="https://www.youtube.com/embed/${id}?rel=0" frameborder="0" allowfullscreen></iframe></div>`;
                } else if(data.type === 'tiktok') {
                    const details = getTikTokDetails(data.url);
                    if(details) {
                        card.innerHTML = `
                        <div class="media-header">${data.title}</div>
                        <div class="responsive-iframe-container video-9-16">
                            <iframe src="https://www.tiktok.com/embed/v2/${details.id}" frameborder="0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>
                        </div>`;
                    }
                } else if(data.type === 'instagram') {
                    const id = getInstagramId(data.url);
                    if(id) card.innerHTML = `<div class="media-header">${data.title}</div><div class="responsive-iframe-container" style="padding-bottom:125%; max-width:540px;"><iframe src="https://www.instagram.com/p/${id}/embed/" frameborder="0" scrolling="no" allowtransparency="true" allow="encrypted-media" sandbox="allow-scripts allow-same-origin allow-presentation allow-forms"></iframe></div>`;
                } else if(data.type === 'telegram') {
                     card.innerHTML = `<div class="media-header">${data.title}</div><div class="telegram-link-card"><span class="telegram-icon">üìÑ</span><a href="${data.url}" target="_blank" class="btn btn-outline" style="width:auto; flex:1;">Open</a></div>`;
                }
                container.appendChild(card);
            });
        }
        async function loadUserEvents() {
            const snap = await getDocs(collection(db, "events"));
            const container = document.getElementById('events-list-container');
            container.innerHTML = '';
            snap.forEach(doc => {
                const e = doc.data();
                container.innerHTML += `<div class="card mb-2"><h4>${e.title}</h4><p>${e.date} | ${e.location}</p></div>`;
            });
        }
        async function loadDonations() {
            const docRef = doc(db, "settings", "donations");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                document.getElementById('donation-cause-title').textContent = d.cause;
                document.getElementById('donation-percent-text').textContent = d.percent + "%";
                document.getElementById('donation-progress-bar').style.width = d.percent + "%";
                document.getElementById('don-modal-bank').textContent = d.bank || "N/A";
                document.getElementById('don-modal-name').textContent = d.accName || "N/A";
                document.getElementById('don-modal-num').textContent = d.accNum || "N/A";
            }
        }
        window.openDonationModal = () => { document.getElementById('donation-modal').classList.remove('hidden'); };
        window.copyToClipboard = () => {
            const text = document.getElementById('don-modal-num').textContent;
            navigator.clipboard.writeText(text);
            showToast("Copied!");
        };
        window.updateProfile = async () => {
            const oldPass = document.getElementById('edit-old-pass').value;
            const newPass = document.getElementById('edit-new-pass').value;
            const updateData = {};
            const prefix = 'edit-';

            if (newPass) {
                if(!oldPass) return showToast("Enter old password to change password");
                const oldHash = await hashPassword(oldPass);
                if(oldHash !== currentUser.passwordHash) return showToast("Old password incorrect");
                updateData.passwordHash = await hashPassword(newPass);
            }

            for(const field of formSchema) {
                const el = document.getElementById(prefix + field.id);
                if(el && field.id !== 'password') {
                    const val = el.value;
                    if(field.id === 'username' && val !== currentUser.username) {
                        const q = query(collection(db, "users"), where("username", "==", val));
                        const snap = await getDocs(q);
                        if(!snap.empty) return showToast("Username already taken");
                    }
                    updateData[field.id] = val;
                }
            }

            const ref = doc(db, "users", currentUser.id);
            await updateDoc(ref, updateData);
            
            currentUser = { ...currentUser, ...updateData };
            localStorage.setItem('ug_user_session', JSON.stringify(currentUser));
            
            document.getElementById('edit-old-pass').value = '';
            document.getElementById('edit-new-pass').value = '';
            
            showToast("Profile Updated Successfully!");
        };
        async function loadAttendanceHistory() {
            const list = document.getElementById('attendance-history-list');
            
            if(!currentUser || !currentUser.id) {
                list.innerHTML = "<p>User session invalid. Please login again.</p>";
                return;
            }

            list.innerHTML = "Loading...";

            try {
                const qGen = query(collection(db, "attendance_general"), where("userId", "==", currentUser.id));
                const qEvt = query(collection(db, "attendance_events"), where("userId", "==", currentUser.id));

                const [snapGen, snapEvt] = await Promise.all([getDocs(qGen), getDocs(qEvt)]);

                const allRecords = [];

                snapGen.forEach(d => {
                    const data = d.data();
                    if (data.timestamp) {
                        allRecords.push({ 
                            ...data, 
                            typeDisplay: data.category || 'General', // Use category if available
                            date: data.timestamp.toDate() 
                        });
                    }
                });

                snapEvt.forEach(d => {
                    const data = d.data();
                    if (data.timestamp) {
                        allRecords.push({ 
                            ...data, 
                            typeDisplay: data.eventTitle || 'Event', 
                            date: data.timestamp.toDate() 
                        });
                    }
                });

                allRecords.sort((a, b) => b.date - a.date);

                if (allRecords.length === 0) {
                    list.innerHTML = `<p><strong>Total Records: 0</strong></p><p>No attendance records found yet.</p>`;
                } else {
                    list.innerHTML = `<p><strong>Total Records: ${allRecords.length}</strong></p><ul style="margin-top:10px; padding-left:20px;">`;
                    allRecords.forEach(r => {
                        const dateStr = r.date.toLocaleDateString();
                        list.innerHTML += `<li>${dateStr} - <span style="color:var(--primary)">${r.typeDisplay}</span></li>`;
                    });
                    list.innerHTML += "</ul>";
                }

            } catch (error) {
                console.error("Error loading attendance history:", error);
                list.innerHTML = `<p style="color:red;">Error loading history: ${error.message}</p>`;
            }
        }
        async function loadUserNotifications() {
            const snap = await getDocs(query(collection(db, "notifications"), orderBy("timestamp", "desc"), limit(1)));
            if (!snap.empty) {
                const notif = snap.docs[0].data();
                if (sessionStorage.getItem('seen_notif_' + notif.id) !== 'true') {
                    document.getElementById('notif-text').textContent = notif.message;
                    document.getElementById('notif-modal').classList.remove('hidden');
                }
            }
        }
        window.closeNotifModal = () => { document.getElementById('notif-modal').classList.add('hidden'); };
        
        window.exportPDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Unity Gebigubae - Full System Report", 14, 20);
            
            const usersSnap = await getDocs(collection(db, "users"));
            const data = await calculateAttendanceData(usersSnap);

            const tableColumn = ["Name", "Username", "Dept", "Batch", "Gen Days", "Event Days", "Total"];
            const tableRows = [];
            data.forEach(u => {
                tableRows.push([u.name, u.username, u.dept, u.batch, u.genDays, u.evtDays, u.totalDays]);
            });
            doc.autoTable(tableColumn, tableRows, { startY: 30 });
            doc.save("ug_full_report.pdf");
            showToast("Full PDF Downloaded");
        };

    </script>
</body>
</html>